Resources:
  sslSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0
  ntfrexBlogEbsExecutionRole:
    Type: AWS::IAM::Role
    Properties:
	  RoleName: 'aws-elasticbeanstalk-ec2-role-ntfrex-blog'
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - 'ec2.amazonaws.com'
            Action:
              - 'sts:AssumeRole'
      Policies:
        - PolicyName: ntfrexBlogEbsExecutionPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              Effect: Allow
              Resource: '*'
              Action:
                - 'logs:*'
                - 'xray:*'
                - 'ssm:GetParameters'

commands:
  reroute_https_443_to_5001:
    command: "iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 443 -j REDIRECT --to-port 5001"
  01_download_otel_collector:
    command: "wget https://aws-otel-collector.s3.amazonaws.com/amazon_linux/amd64/latest/aws-otel-collector.rpm"
  02_install_otel_collector:
    command: "rpm -qa | grep -qw 'aws-otel-collector' || sudo rpm -Uvh  ./aws-otel-collector.rpm"
  03_stop_otel_collector:
    command: "sudo /opt/aws/aws-otel-collector/bin/aws-otel-collector-ctl  -a stop"
  04_run_otel_collector:
    command: "sudo /opt/aws/aws-otel-collector/bin/aws-otel-collector-ctl -c /var/app/current/otel_config.yaml -a start"

# https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/command-options-general.html
option_settings:
  aws:autoscaling:launchconfiguration:
    IamInstanceProfile: 'aws-elasticbeanstalk-ec2-role-ntfrex-blog'
  aws:elasticbeanstalk:environment:
    ServiceRole: 'aws-elasticbeanstalk-service-role'
  aws:elasticbeanstalk:application:environment:
    ASPNETCORE_ENVIRONMENT: "Production"
    NtFrexMySqlConfigPw: ""
    NtFrexMySqlConfigServer: ""
    NtFrexMySqlConfigUser: ""
    NtFrexConfigSecret: ""
  aws:elasticbeanstalk:cloudwatch:logs:
    StreamLogs: true
